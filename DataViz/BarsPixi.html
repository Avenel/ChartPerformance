<!DOCTYPE HTML>
<html>
<head>
    <title>pixi.js barcharts example</title>
    <style>
        body {
            margin: 0;
            background-color: #FFFFFF;
        }
    </style>
    
    <script src="d3.v3.min.js"></script>
    <script src="pixi.js"></script>
    
</head>
<body>
    <script>
        // data
        var bullets = 
            [
              {"title":"Revenue","subtitle":"US$, in thousands","ranges":[150,225,300],"measures":[220,270],"markers":[250]},
              {"title":"Profit","subtitle":"%","ranges":[20,25,30],"measures":[21,23],"markers":[26]},
              {"title":"Order Size","subtitle":"US$, average","ranges":[350,500,600],"measures":[100,320],"markers":[550]},
              {"title":"New Customers","subtitle":"count","ranges":[1400,2000,2500],"measures":[1000,1650],"markers":[2100]},
              {"title":"Satisfaction","subtitle":"out of 5","ranges":[3.5,4.25,5],"measures":[3.2,4.7],"markers":[4.4]}
            ] 

        // create an new instance of a pixi stage
        var stage = new PIXI.Stage(0xFFFFFF, true);

        var w = 300,
            h = 460;

        var renderer = PIXI.autoDetectRenderer(w, h);

        // container element for bulletGraphics
        var graphics = new Array();

        // indicates if animation should be active or not (one should not animate, if the viz is already static)
        var global_animate = true

        // add render view to DOM
        document.body.appendChild(renderer.view);
    
        // Add our "custom" sketch element to the body.
        var sketch = d3.select("body").append("custom:sketch")
            .attr("width", w)
            .attr("height", h);

        // scaling for bullet width
        var bulletWidth = d3.scale.linear()
            .domain( 
                d3.extent( bullets.map( 
                    function( el ) {
                        return el.ranges[0];
                    })
                ) 
            )
            .range( [0, w]);

        // calculate yPosition of bullet
        var yPos = d3.scale.ordinal()
            .domain( d3.range( bullets.length ) )
            .rangeRoundBands( [0, h], 0.1 );

        // append bullet objects to sketch
        var bullet = sketch.selectAll("rect")
            .data(bullets)
            .enter()
            .append( 'rect' )
            .attr({
                x: 0,
                y: function( d, i ) {
                 return  yPos(i);
                },
                width: function( d, i ) {
                    return 0;
                },
                height: yPos.rangeBand(),
                fill: 'red',
                max_width: function( d, i ) {
                    return bulletWidth(d.ranges[0]);
                },
                value: function( d, i ) {
                    return d.ranges[0];
                },
                animate: true
            })
            .transition()
                .duration(1000)
                .attr("width", function ( d, i ) {
                    return bulletWidth(d.ranges[0]);
                })
            .call(drawBullets);
            
        // insert bullets into pixi canvas
        function drawBullets() {
            var root = d3.select("sketch")[0][0];

            for (var child = root.firstChild; child; child = child.nextSibling) {
                drawBullet(child);
            }    
        };

        function drawBullet (element) {
            var graphic = new PIXI.Graphics();
            graphic.beginFill(0xB0C4DE);
            graphic.drawRect(  parseInt(element.getAttribute("x")), parseInt(element.getAttribute("y")), 
                                parseInt(element.getAttribute("width")), parseInt(element.getAttribute("height")));
            graphic.endFill();

            // make the graphic interactive..
            graphic.interactive = true;

            // set the mousedown and touchstart callback..
            graphic.mousedown = graphic.touchstart = function(data) {
                alert(parseInt(element.getAttribute("value")));
            };

            graphics[graphics.length] = graphic;
            stage.addChild(graphic);
        };


        function updateBullets() {
            var root = d3.select("sketch")[0][0];
            var i = 0;
            var animate_false = 0;
            
            for (var child = root.firstChild; child; child = child.nextSibling) {
                var graphic = graphics[i];

                if (parseBoolean(child.getAttribute("animate"))) {
                    graphic.clear();
                    graphic.beginFill(0xB0C4DE);

                    graphic.drawRect(  parseInt(child.getAttribute("x")), parseInt(child.getAttribute("y")), 
                                parseInt(child.getAttribute("width")), parseInt(child.getAttribute("height")));

                    graphic.endFill();
                }

                if (child.getAttribute("width") == child.getAttribute("max_width")) {
                    child.setAttribute("animate", false);
                    animate_false++;
                }
                i++;
            }
            

            // if every bullet was animated, turn off animation
            if (animate_false == root.children.length) {
                global_animate = false;
            }
        }

        // run the render loop
        requestAnimFrame(animate);

        renderer.render(stage);
        function animate() {
            if (!global_animate) return;

            updateBullets();
            renderer.render(stage);
            requestAnimFrame(animate);
        }

        function parseBoolean(str) {
            return (str == "true");
        }

    </script>
</body>
</html>