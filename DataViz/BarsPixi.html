<!DOCTYPE HTML>
<html>
<head>
    <title>pixi.js barcharts example</title>
    <style>
        body {
            margin: 0;
            background-color: #FFFFFF;
        }
    </style>
    
    <script src="d3.v3.min.js"></script>
    <script src="pixi.js"></script>
    
</head>
<body>
    <!-- <button onclick="onRndButton();">Update</button> -->
    <script>
        // data
        var bullets = 
            [
              {"title":"Revenue","subtitle":"US$, in thousands","ranges":[150,225,300],"measures":[220,270],"markers":[250]},
              {"title":"Profit","subtitle":"%","ranges":[20,25,30],"measures":[21,23],"markers":[26]},
              {"title":"Order Size","subtitle":"US$, average","ranges":[350,500,600],"measures":[100,320],"markers":[550]},
              {"title":"New Customers","subtitle":"count","ranges":[1400,2000,2500],"measures":[1000,1650],"markers":[2100]},
              {"title":"Satisfaction","subtitle":"out of 5","ranges":[3.5,4.25,5],"measures":[3.2,4.7],"markers":[4.4]}
            ] 

        // create an new instance of a pixi stage
        var stage = new PIXI.Stage(0xFFFFFF, true);

        var w = 300,
            h = 200;

        var renderer = PIXI.autoDetectRenderer(w, h);

        // container element for bulletGraphics
        var graphics = new Array();

        // indicates if animation should be active or not (one should not animate, if the viz is already static)
        var global_animate = true

        // add render view to DOM
        document.body.appendChild(renderer.view);
    
        // Add our "custom" sketch element to the body.
        var sketch = d3.select("body").append("custom:sketch")
            .attr("width", w)
            .attr("height", h);

        // scaling for bullet width
        function bulletWidth (val, range) {
            var width = d3.scale.linear()
                    .domain(range)
                    .range( [0, w]);
            //  console.log(width(val));
            return width(val);
        }

        // calculate yPosition of bullet
        var yPos = d3.scale.ordinal()
            .domain( d3.range( bullets.length ) )
            .rangeRoundBands( [0, h], 0.4 );

        // append bullet objects to sketch
        var bullet = sketch.selectAll("bullet")
            .data(bullets)
            .enter()
            .append( 'bullet' )
            .attr({
                x: 0,
                y: function( d, i ) {
                 return  yPos(i);
                },
                width: function( d, i ) {
                    return 0;
                },
                height: yPos.rangeBand(),
                max_width: function( d, i ) {
                    return bulletWidth(d.measures[0], [0, d.ranges[2]]);
                },
                val_current: function( d, i ) {
                    return d.measures[0];
                },
                val_last: function ( d, i ) {
                    return d.markers[0];
                },
                val_plan: function ( d, i ) {
                    return d.measures[1];
                },
                range_red: function ( d, i ) {
                    return d.ranges[0];
                },
                range_yellow: function ( d, i ) {
                    return d.ranges[1];
                },
                range_green: function ( d, i ) {
                    return d.ranges[2];
                },
                animate: true
            })
            .transition()
                .duration(1000)
                .attr("width", function ( d, i ) {
                    return bulletWidth(d.measures[0], [0, d.ranges[2]]);
                })
            .call(drawBullets);
            
        // insert bullets into pixi canvas
        function drawBullets() {
            var root = d3.select("sketch")[0][0];

            for (var child = root.firstChild; child; child = child.nextSibling) {
                drawBullet(child);
            }    
        };

        function getRangeOfBullet (element) {
            var range = [0, parseFloat(element.getAttribute("range_green"))];
            return range;
        }

        function drawBullet (element) {
            var graphic = new PIXI.Graphics();

            // ranges
            var range = getRangeOfBullet(element);

            graphic.beginFill(0xEEEEEE);
            graphic.drawRect(   parseFloat(element.getAttribute("x")), parseFloat(element.getAttribute("y")), 
                                bulletWidth(parseFloat(element.getAttribute("range_green")), range), parseFloat(element.getAttribute("height")));

            graphic.beginFill(0xDDDDDD);
            graphic.drawRect(   parseFloat(element.getAttribute("x")), parseFloat(element.getAttribute("y")), 
                                bulletWidth(parseFloat(element.getAttribute("range_yellow")), range), parseFloat(element.getAttribute("height")));

            graphic.beginFill(0xCCCCCC);
            graphic.drawRect(   parseFloat(element.getAttribute("x")), parseFloat(element.getAttribute("y")), 
                                bulletWidth(parseFloat(element.getAttribute("range_red")), range), parseFloat(element.getAttribute("height")));

            // current val
            graphic.beginFill(0x4682B4);
            graphic.drawRect(   parseFloat(element.getAttribute("x")), parseFloat(element.getAttribute("y")), 
                                parseFloat(element.getAttribute("width")), parseFloat(element.getAttribute("height")));
            
            // plan val
            graphic.beginFill(0xB0C4DE);
            graphic.drawRect(   parseFloat(element.getAttribute("x")), 
                                parseFloat(element.getAttribute("y")) + (parseFloat(element.getAttribute("height")) * 0.25), 
                                bulletWidth(parseFloat(element.getAttribute("val_plan")), range), parseFloat(element.getAttribute("height")) * 0.5);

            // last val
            graphic.beginFill(0x000000);
            graphic.drawRect(   bulletWidth(parseFloat(element.getAttribute("val_last")), range), 
                                parseFloat(element.getAttribute("y")) + (parseFloat(element.getAttribute("height")) * 0.15), 
                                2, parseFloat(element.getAttribute("height")) * 0.7);

            graphic.endFill();

            // make the graphic interactive..
            graphic.interactive = true;

            // set the mousedown and touchstart callback..
            graphic.mousedown = graphic.touchstart = function(data) {
                alert(parseFloat(element.getAttribute("val_current")));
            };

            graphics[graphics.length] = graphic;
            stage.addChild(graphic);
        };


        function updateBullets() {
            var root = d3.select("sketch")[0][0];
            var i = 0;
            var animate_false = 0;
            
            for (var child = root.firstChild; child; child = child.nextSibling) {
                var graphic = graphics[i];

                if (parseBoolean(child.getAttribute("animate"))) {
                    // graphic.clear();
                    graphic.beginFill(0x4682B4);

                    graphic.drawRect(  parseFloat(child.getAttribute("x")), 
                            parseFloat(child.getAttribute("y")) + (parseFloat(child.getAttribute("height")) * 0.25), 
                            parseFloat(child.getAttribute("width")), parseFloat(child.getAttribute("height")) * 0.5);

                    graphic.endFill();
                }

                if (child.getAttribute("width") == child.getAttribute("max_width")) {
                    child.setAttribute("animate", false);
                    animate_false++;
                }
                i++;
            }
            

            // if every bullet was animated, turn off animation
            if (animate_false == root.children.length) {
                global_animate = false;
            }
        }

        // run the render loop
        requestAnimFrame(animate);

        renderer.render(stage);
        function animate() {
            if (!global_animate) return;

            updateBullets();
            renderer.render(stage);
            requestAnimFrame(animate);
        }

        function parseBoolean(str) {
            return (str == "true");
        }

        // Random values button . WIP
        function randomize(d) {
            if (!d.randomizer) d.randomizer = randomizer(d);
            d.ranges = d.ranges.map(d.randomizer);
            d.markers = d.markers.map(d.randomizer);
            d.measures = d.measures.map(d.randomizer);
            return d;
        }

        function randomizer(d) {
            var k = d3.max(d.ranges) * .2;
            return function(d) {
                return Math.max(0, d + k * (Math.random() - .5));
            };
        }

        function onRndButton() {
            alert("rand");
            bullet.datum(randomize).call(drawBullets); // TODO automatic transition
        }
    </script>
</body>
</html>