<!DOCTYPE HTML>
<html>
<head>
    <title>pixi.js barcharts example</title>
    <style>
        body {
            margin: 0;
            background-color: #FFFFFF;
        }
    </style>
    
    <script src="d3.v3.min.js"></script>
    <script src="pixi.dev.js"></script>
    <script src="chartLib.js"></script>
    
</head>
<body>
    <!-- <button onclick="onRndButton();">Update</button> -->
    <script>
        // data
        var bullets = 
            [
              {"title":"Revenue","subtitle":"US$, in thousands","ranges":[150,225,300],"measures":[220,270],"markers":[250]},
              {"title":"Profit","subtitle":"%","ranges":[20,25,30],"measures":[21,23],"markers":[26]},
              {"title":"Order Size","subtitle":"US$, average","ranges":[350,500,600],"measures":[100,320],"markers":[550]},
              {"title":"New Customers","subtitle":"count","ranges":[1400,2000,2500],"measures":[1000,1650],"markers":[2100]},
              {"title":"Satisfaction","subtitle":"out of 5","ranges":[3.5,4.25,5],"measures":[3.2,4.7],"markers":[4.4]}
            ] 

        // create an new instance of a pixi stage
        var stage = new PIXI.Stage(0xFFFFFF, true);

        var w = 300,
            h = 200;

        var renderer = PIXI.autoDetectRenderer(w, h);

        // container element for bulletGraphics
        var graphics = new Array();

        // indicates if animation should be active or not (one should not animate, if the viz is already static)
        var global_animate = true

        // add render view to DOM
        document.body.appendChild(renderer.view);
    
        // Add our "custom" sketch element to the body.
        var sketch = d3.select("body").append("custom:sketch")
            .attr("width", w)
            .attr("height", h);

        // scaling for bullet width
        function bulletWidth (val, range) {
            var width = d3.scale.linear()
                    .domain(range)
                    .range( [0, w]);
            return width(val);
        }

        // calculate yPosition of bullet
        var yPos = d3.scale.ordinal()
            .domain( d3.range( bullets.length ) )
            .rangeRoundBands( [0, h], 0.4 );

        // append bullet objects to sketch
        var bullet = sketch.selectAll("bullet").data(bullets);
        bullet.enter()
            .append( 'bullet' )
            .attr({
                x: 0,
                y: function( d, i ) {
                 return  yPos(i);
                },
                width: function( d, i ) {
                    return 0;
                },
                height: yPos.rangeBand(),
                max_width: w,
                val_current: function( d, i ) {
                    return d.measures[0];
                },
                val_last: function ( d, i ) {
                    return d.markers[0];
                },
                val_plan: function ( d, i ) {
                    return d.measures[1];
                },
                range_red: function ( d, i ) {
                    return d.ranges[0];
                },
                range_yellow: function ( d, i ) {
                    return d.ranges[1];
                },
                range_green: function ( d, i ) {
                    return d.ranges[2];
                },
                animate: true
            });

        bullet.transition()
            .duration(1000)
            .attr("width", function ( d, i ) {
                return bulletWidth(d.measures[0], [0, d.ranges[2]]);
            })
            .call(addBullets);
            
        // insert bullets into pixi canvas
        function addBullets() {
            var root = d3.select("sketch")[0][0];
            for (var child = root.firstChild; child; child = child.nextSibling) {
                stage.addChild(new ChartLib.Bullet(child));
            }    
        };

        function getRangeOfBullet (element) {
            var range = [0, parseFloat(element.getAttribute("range_green"))];
            return range;
        }

        // run the render loop
        requestAnimFrame(animate);

        renderer.render(stage);
        function animate() {
            if (!global_animate) return;

            // updateBullets();
            renderer.render(stage);
            requestAnimFrame(animate);
        }

        function parseBoolean(str) {
            return (str == "true");
        }
    </script>
</body>
</html>