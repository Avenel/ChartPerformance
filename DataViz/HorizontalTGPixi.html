<!DOCTYPE HTML>
<html>
<head>
    <title>pixi.js barcharts example</title>
    <style>
        body {
            margin: 0;
            background-color: #FFFFFF;
        }
    </style>
    
    <script src="d3.v3.min.js"></script>
    <script src="pixi.dev.js"></script>
    <script src="chartLib.js"></script>
    <script src="http://10.10.51.243:8080/target/target-script-min.js#anonymous"></script>
    
</head>
<body>
    <canvas id="chart"></canvas>
    <script>
        // data
        var bullets = 
            [
              {"title":"Germany", "ranges":[150,225,300], "measures":[220,270], "markers":[200]},
              {"title":"France", "ranges":[200,250,300], "measures":[210,230], "markers":[260]},
              {"title":"Spain", "ranges":[150,200,260], "measures":[200, 220], "markers":[250]},
              {"title":"Italy", "ranges":[140,200,250], "measures":[100,165], "markers":[210]},
              {"title":"Netherlands", "ranges":[40,70,100], "measures":[80, 85], "markers":[95]}
            ] 

        // create an new instance of a pixi stage
        var stage = new PIXI.Stage(0xFFFFFF, true);

        // for retina displays its important to consider the devicePixelRatio...
        var scale = window.devicePixelRatio;
        var w = 300,
            h = 300,
            padding = 18,

            // fontsize in em for ibcs standard measure
            fs = 1;
            // 1em = 16px (default browser value)
            pxs = (fs * 16),
            w = w*fs,
            h = h*fs;

        var canvas = document.getElementById('chart');
        var options = new function() { 
            this.transparent = false;
            this.view = canvas;
        }
        
        var renderer = PIXI.autoDetectRecommendedRenderer(w*scale, h*scale, options);
        canvas.style.width = w + 'px';
        canvas.style.height = h + 'px';

        d3.select("body").append("custom:renderer")
            .attr("renderer", (renderer instanceof PIXI.CanvasRenderer)? "canvas" : "webgl");


        // container element for bulletGraphics
        var graphics = new Array();

        // indicates if animation should be active or not (one should not animate, if the viz is already static)
        var global_animate = true

        // add render view to DOM
        document.body.appendChild(renderer.view);
    
        // Add our "custom" sketch element to the body.
        var sketch = d3.select("body").append("cxustom:sketch")
            .attr("width", w)
            .attr("height", h);

        // calculate yPosition of bullet
        var yPos = d3.scale.ordinal()
            .domain( d3.range( bullets.length ) )
            .rangeRoundBands( [0, h - (2*padding)], 0.2 );

        var xPos = d3.scale.ordinal()
            .domain( d3.range( bullets.length ) )
            .rangeRoundBands( [0, w - (2*padding)], 0.37 );

        // append bullet objects to sketch
        var bullet = sketch.selectAll("bullet").data(bullets);
        bullet.enter()
            .append( 'bullet' )
            .attr({
                title: function( d, i ) {
                    return d.title;
                },
                title_width: 5*pxs,
                x: padding,
                y: function( d, i ) {
                 return yPos(i) + (i-1)*0.15*pxs;
                 },
                width: function( d, i ) {
                    return 0;
                },
                pxs: pxs,
                height: yPos.rangeBand(),
                max_width: w - (2*padding),
                scale: scale,
                domain_min: 0,
                domain_max: 300,
                val_current: function( d, i ) {
                    return d.measures[0];
                },
                val_last: function ( d, i ) {
                    return d.markers[0];
                },
                val_plan: function ( d, i ) {
                    return d.measures[1];
                },
                range_red: function ( d, i ) {
                    return d.ranges[0];
                },
                range_yellow: function ( d, i ) {
                    return d.ranges[1];
                },
                range_green: function ( d, i ) {
                    return d.ranges[2];
                },
                animate: true
            })
            .call(addBullets);

        bullet.transition()
            .duration(1000)
            .attr("width", function ( d, i ) {
                return d.measures[0];
            })
            .each('end', pauseBulletUpdate);
            
        // insert bullets into pixi canvas
        function addBullets() {
            var root = d3.select("sketch")[0][0];
            for (var child = root.firstChild; child; child = child.nextSibling) {
                stage.addChild(new ChartLib.HorizontalTargetGraph(child));
            }    
        };

        function updateBullets () {
            var root = d3.select("sketch")[0][0];
            var i = 0;
            for (var child = root.firstChild; child; child = child.nextSibling) {
                if (i < stage.children.length) {
                    var b = stage.children[i];
                    if (b.animate) {
                        b.update(child);
                    }
                }
                i++;
            }
        }

        function pauseBulletUpdate () {
            for (var i = 0; i < stage.children.length; i++) {
                stage.children[i].animate = false;
            }
        };

        // run the render loop
        requestAnimFrame(animate);

        renderer.render(stage);

        function animate() {
            updateBullets();
            renderer.render(stage);
            requestAnimFrame(animate);
        }

        function parseBoolean(str) {
            return (str == "true");
        }
    </script>
</body>
</html>